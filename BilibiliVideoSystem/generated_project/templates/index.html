{% extends "base.html" %}

{% block content %}
<div class="container">
    <nav class="navbar">
        <div class="nav-brand">Bç«™è§†é¢‘é¢„è§ˆå¹³å°</div>
        <div class="nav-links">
            <a href="#" class="nav-link">é¦–é¡µ</a>
            <a href="#" class="nav-link">çƒ­é—¨</a>
            <a href="#" class="nav-link">åˆ†ç±»</a>
        </div>
    </nav>
    
    <header class="page-header">
        <h1 class="page-title">Bç«™è§†é¢‘é¢„è§ˆå¹³å°</h1>
        <p class="page-subtitle">ç‚¹å‡»ä¸‹æ–¹å¡ç‰‡è·³è½¬åˆ°Bç«™è§‚çœ‹å®Œæ•´è§†é¢‘</p>
    </header>

    <!-- è§†é¢‘ä¸Šä¼ è¡¨å• -->
    <div class="upload-section">
        <h2 class="upload-title">ä¸Šä¼ è§†é¢‘ä¿¡æ¯</h2>
        <form id="videoUploadForm" class="upload-form">
            <div class="form-group">
                <label for="videoTitle">è§†é¢‘æ ‡é¢˜ *</label>
                <input type="text" id="videoTitle" name="title" required class="form-input">
            </div>
            
            <div class="form-group">
                <label for="videoUrl">Bç«™è§†é¢‘é“¾æ¥ *</label>
                <input type="url" id="videoUrl" name="bilibili_url" required class="form-input" 
                       placeholder="https://www.bilibili.com/video/BV..." 
                       pattern="https://www\.bilibili\.com/video/.*">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="upName">UPä¸»åç§°</label>
                    <input type="text" id="upName" name="up_name" class="form-input">
                </div>
                
                <div class="form-group">
                    <label for="publishDate">å‘å¸ƒæ—¥æœŸ</label>
                    <input type="text" id="publishDate" name="publish_date" class="form-input" placeholder="YYYY-MM-DD">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="playCount">æ’­æ”¾é‡</label>
                    <input type="text" id="playCount" name="play_count" class="form-input" value="0">
                </div>
                
                <div class="form-group">
                    <label for="danmakuCount">å¼¹å¹•æ•°</label>
                    <input type="text" id="danmakuCount" name="danmaku_count" class="form-input" value="0">
                </div>
            </div>
            
            <div class="form-group">
                <label for="coverColor">å°é¢é¢œè‰²</label>
                <input type="text" id="coverColor" name="cover_color" class="form-input" value="linear-gradient(45deg, #00a1d6, #fb7299)" placeholder="linear-gradient(45deg, #color1, #color2)">
            </div>
            
            <div class="form-group">
                <label for="videoDescription">è§†é¢‘æè¿°</label>
                <textarea id="videoDescription" name="description" class="form-textarea" rows="3"></textarea>
            </div>
            
            <button type="submit" class="upload-btn">
                <span class="btn-icon">ğŸ“¤</span>
                ä¸Šä¼ è§†é¢‘ä¿¡æ¯
            </button>
        </form>
        
        <div id="uploadStatus" class="upload-status"></div>
    </div>
    
    <div class="videos-grid">
        {% for video in videos %}
        <div class="video-card" data-video-id="{{ video.id }}">
            <div class="video-cover-container">
                <div class="video-cover" style="background: {{ video.cover_color }};"></div>
                <div class="video-overlay">
                    <a href="{{ video.bilibili_url }}" class="play-link" target="_blank">
                        <span class="play-icon">â–¶</span>
                    </a>
                </div>
            </div>
            <div class="video-content">
                <h3 class="video-title">{{ video.title }}</h3>
                <div class="video-meta">
                    <div class="meta-item">
                        <span class="meta-icon">ğŸ‘ï¸</span>
                        <span>{{ video.play_count }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-icon">ğŸ’¬</span>
                        <span>{{ video.danmaku_count }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-icon">ğŸ“…</span>
                        <span>{{ video.publish_date }}</span>
                    </div>
                </div>
                <div class="up-info">
                    <div class="up-avatar">
                        <span class="avatar-text">UP</span>
                    </div>
                    <div class="up-details">
                        <div class="up-name">{{ video.up_name }}</div>
                        <div class="up-badge">UPä¸»</div>
                    </div>
                </div>
                <p class="video-desc">{{ video.description }}</p>
                <div class="video-actions">
                    <a href="{{ video.bilibili_url }}" class="watch-btn" target="_blank">
                        <span class="btn-icon">â–¶</span>
                        å‰å¾€Bç«™è§‚çœ‹å®Œæ•´è§†é¢‘
                    </a>
                    <button class="delete-btn" onclick="deleteVideo({{ video.id }})" data-video-id="{{ video.id }}">
                        <span class="btn-icon">ğŸ—‘ï¸</span>
                        åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <footer class="page-footer">
        <div class="footer-content">
            <p class="footer-text">æœ¬å¹³å°ä»…ç”¨äºé¢„è§ˆBç«™è§†é¢‘ä¿¡æ¯ï¼Œå®Œæ•´å†…å®¹è¯·å‰å¾€Bç«™è§‚çœ‹</p>
            <div class="footer-links">
                <a href="#" class="footer-link">å…³äºæˆ‘ä»¬</a>
                <a href="#" class="footer-link">éšç§æ”¿ç­–</a>
                <a href="#" class="footer-link">è”ç³»æˆ‘ä»¬</a>
            </div>
        </div>
    </footer>
</div>

<script>
function deleteVideo(videoId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§†é¢‘å—ï¼Ÿ')) {
        fetch(`/api/delete_video/${videoId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('åˆ é™¤å¤±è´¥: ' + data.error);
            } else {
                // ä»é¡µé¢ç§»é™¤è§†é¢‘å¡ç‰‡
                const videoCard = document.querySelector(`[data-video-id="${videoId}"]`);
                if (videoCard) {
                    videoCard.remove();
                }
                alert('è§†é¢‘åˆ é™¤æˆåŠŸ');
            }
        })
        .catch(error => {
            alert('ç½‘ç»œé”™è¯¯: ' + error.message);
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('videoUploadForm');
    const uploadStatus = document.getElementById('uploadStatus');

    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // ä¿®æ­£IDå¼•ç”¨ - ä¸HTMLä¸­çš„IDä¿æŒä¸€è‡´
            const formData = {
                title: document.getElementById('videoTitle').value,
                bilibili_url: document.getElementById('videoUrl').value,
                cover_color: document.getElementById('coverColor').value,
                play_count: document.getElementById('playCount').value || '0',
                danmaku_count: document.getElementById('danmakuCount').value || '0',
                publish_date: document.getElementById('publishDate').value,
                up_name: document.getElementById('upName').value,
                description: document.getElementById('videoDescription').value
            };
            
            // æ¸…é™¤ä¹‹å‰çš„éªŒè¯æ ·å¼
            const videoUrlInput = document.getElementById('videoUrl');
            if (uploadStatus && videoUrlInput) {
                videoUrlInput.style.borderColor = '';
                uploadStatus.style.display = 'none';
            }
            
            // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            if (uploadStatus) {
                uploadStatus.textContent = 'ä¸Šä¼ ä¸­...';
                uploadStatus.className = 'upload-status uploading';
                uploadStatus.style.display = 'block';
            }
            
            // å‘é€è¯·æ±‚åˆ°åç«¯
            fetch('/api/add_video', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (uploadStatus) {
                    if (data.error) {
                        uploadStatus.textContent = 'ä¸Šä¼ å¤±è´¥: ' + data.error;
                        uploadStatus.className = 'upload-status error';
                        
                        // å¦‚æœæ˜¯URLé”™è¯¯ï¼Œé«˜äº®æ˜¾ç¤ºURLè¾“å…¥æ¡†
                        if (data.error.includes('é“¾æ¥') || data.error.includes('URL')) {
                            videoUrlInput.style.borderColor = '#ff4757';
                        }
                    } else {
                        uploadStatus.textContent = 'ä¸Šä¼ æˆåŠŸï¼';
                        uploadStatus.className = 'upload-status success';
                        
                        // æ¸…ç©ºè¡¨å•
                        uploadForm.reset();
                        
                        // åŠ¨æ€æ·»åŠ æ–°è§†é¢‘åˆ°é¡µé¢
                        if (data.video) {
                            addVideoToPage(data.video);
                        }
                    }
                    uploadStatus.style.display = 'block';
                }
            })
            .catch(error => {
                if (uploadStatus) {
                    uploadStatus.textContent = 'ç½‘ç»œé”™è¯¯: ' + error.message;
                    uploadStatus.className = 'upload-status error';
                    uploadStatus.style.display = 'block';
                }
            });
        });
    }
    
    // æ”¹è¿›åŠ¨æ€æ·»åŠ è§†é¢‘å‡½æ•°
    function addVideoToPage(videoData) {
        const videosGrid = document.querySelector('.videos-grid');
        if (!videosGrid) return;
        
        const videoCard = document.createElement('div');
        videoCard.className = 'video-card';
        videoCard.setAttribute('data-video-id', videoData.id);
        videoCard.innerHTML = `
            <div class="video-cover-container">
                <div class="video-cover" style="background: ${videoData.cover_color || 'linear-gradient(45deg, #00a1d6, #fb7299)'};"></div>
                <div class="video-overlay">
                    <a href="${videoData.bilibili_url || '#'}" class="play-link" target="_blank">
                        <span class="play-icon">â–¶</span>
                    </a>
                </div>
            </div>
            <div class="video-content">
                <h3 class="video-title">${videoData.title || 'æœªå‘½åè§†é¢‘'}</h3>
                <div class="video-meta">
                    <div class="meta-item">
                        <span class="meta-icon">ğŸ‘ï¸</span>
                        <span>${videoData.play_count || '0'}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-icon">ğŸ’¬</span>
                        <span>${videoData.danmaku_count || '0'}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-icon">ğŸ“…</span>
                        <span>${videoData.publish_date || 'æœªçŸ¥æ—¥æœŸ'}</span>
                    </div>
                </div>
                <div class="up-info">
                    <div class="up-avatar">
                        <span class="avatar-text">UP</span>
                    </div>
                    <div class="up-details">
                        <div class="up-name">${videoData.up_name || 'æœªçŸ¥UPä¸»'}</div>
                        <div class="up-badge">UPä¸»</div>
                    </div>
                </div>
                <p class="video-desc">${videoData.description || 'æš‚æ— æè¿°'}</p>
                <div class="video-actions">
                    <a href="${videoData.bilibili_url || '#'}" class="watch-btn" target="_blank">
                        <span class="btn-icon">â–¶</span>
                        å‰å¾€Bç«™è§‚çœ‹å®Œæ•´è§†é¢‘
                    </a>
                    <button class="delete-btn" onclick="deleteVideo(${videoData.id})" data-video-id="${videoData.id}">
                        <span class="btn-icon">ğŸ—‘ï¸</span>
                        åˆ é™¤
                    </button>
                </div>
            </div>
        `;
        
        // æ·»åŠ åˆ°ç½‘æ ¼çš„å¼€å¤´
        videosGrid.insertBefore(videoCard, videosGrid.firstChild);
    }
});
</script>

<style>
.upload-status {
    display: none;
    padding: 12px;
    margin-top: 15px;
    border-radius: 8px;
    font-weight: 500;
}

.upload-status.uploading {
    background: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
}

.upload-status.success {
    background: #e8f5e8;
    color: #2e7d32;
    border: 1px solid #c8e6c9;
}

.upload-status.error {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ffcdd2;
}

.form-input:invalid {
    border-color: #ffcdd2;
}

.form-input:valid {
    border-color: #c8e6c9;
}

/* æ·»åŠ åˆ é™¤æŒ‰é’®æ ·å¼ */
.delete-btn {
    background: #ff4757;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    margin-left: 10px;
    transition: background 0.3s ease;
}

.delete-btn:hover {
    background: #ff3742;
}

/* æ·»åŠ æ’­æ”¾é“¾æ¥æ ·å¼ */
.play-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    text-decoration: none;
    color: white;
    transition: transform 0.3s ease;
}

.play-link:hover {
    transform: scale(1.1);
}

.play-link:hover .play-icon {
    opacity: 0.8;
}

/* ç¡®ä¿è§†é¢‘å°é¢å®¹å™¨æœ‰æ­£ç¡®çš„å®šä½ */
.video-cover-container {
    position: relative;
    cursor: pointer;
}

.video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.2);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.video-cover-container:hover .video-overlay {
    opacity: 1;
}
</style>
{% endblock %}