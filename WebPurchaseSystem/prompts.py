# file: prompts.py

# =============== 项目生成提示模板 ===============
PROJECT_PROMPT = '''\
你是资深 Python 工程师。下面是中文需求，请基于这些需求直接生成一个可运行的 Python 项目，严格只输出文件块：

---FILE: path/to/file.py
<文件内容>
---END_FILE---

必须包含以下文件：
1. README.md - 详细描述项目结构、功能说明和运行方法
2. 启动脚本（run.py 或 app.py 等）
3. requirements.txt（如有第三方依赖）
4. 根据 README.md 中描述的项目结构，生成所有提及的文件

特别注意：
- README.md 中描述的项目结构必须与实际生成的文件完全一致
- 所有在 README.md 中提及的文件都必须实际生成
- 确保文件路径和名称在 README.md 描述与实际文件一致
- 不要输出任何额外说明或多余文本

质量检查清单：
1. 仔细检查 README.md 中列出的所有文件是否都已生成
2. 确保所有路由、模块、组件等都在实际文件中实现
3. 验证前端组件与实际JS文件对应关系
4. 确保后端路由文件与API接口描述一致

---需求开始---
{requirements}
---需求结束---
'''


# =============== 传统修复提示模板 (备用) ===============
REPAIR_PROMPT = '''\
你是资深 Python 工程师。下面是当前项目的相关文件列表（路径 -> 内容），以及一个用户提交的 bug 报告或改进请求。
请根据 bug 报告分析问题，并提供修复方案。只输出需要修改的文件块，格式如下：

---FILE: path/to/file.py
<文件完整内容>
---END_FILE---

如果文件内容过长无法一次性输出，请在截断处添加 "---TRUNCATED---" 标记，并在后续响应中继续生成剩余部分。

请确保：
1. 只修改必要的文件
2. 保持文件的完整性和正确性
3. 不要添加任何解释性文字
4. 严格按照上述格式输出

---文件列表开始---
{files_dump}
---文件列表结束---

---Bug/改进报告---
{bug}
---报告结束---
'''

# =============== BUG2 修复提示模板 (多轮修复流程) ===============

# 1. 初始修复/生成提示
BUG2_REPAIR_PROMPT = '''\
你是资深 Python 工程师。下面是当前项目的相关文件列表（路径 -> 内容），以及一个用户提交的 bug 报告或改进请求。
请根据 bug 报告分析问题，并提供修复方案（或根据需求生成新代码）。只输出需要修改或新增的文件块，格式如下：

---FILE: path/to/file.py
<文件完整内容>
---END_FILE---

如果文件内容过长无法一次性输出，请在截断处添加 "---TRUNCATED---" 标记。

请确保：
1. 严格按照上述文件块格式输出。
2. 不要添加任何解释性文字或额外的非代码内容。

---项目文件列表开始---
{files_dump}
---项目文件列表结束---

---Bug/改进报告---
{bug}
---报告结束---
'''

# 2. 自我检查提示
BUG2_CHECK_PROMPT = '''\
你是资深 Python 工程师和调试专家。你刚刚根据用户请求对项目文件进行了修改。
下面是修改后的项目文件列表（路径 -> 内容），以及用户最初的 bug 报告/需求。
请仔细检查你的修改是否完全满足了用户需求，并且代码中没有引入新的 bug 或语法错误。

如果发现任何需要进一步修改的地方，请再次输出需要修改的文件块。只输出**需要修改**的文件块，格式如下：

---FILE: path/to/file.py
<文件完整内容>
---END_FILE---

如果没有需要修改的地方，请不要输出任何文件块，只输出一个简短的"✅"即可。

请确保：
1. 只输出需要修改的文件块。
2. 严格按照上述文件块格式输出。
3. 不要添加任何解释性文字或额外的非代码内容。

---修改后的项目文件列表开始---
{files_dump}
---项目文件列表结束---

---原始Bug/改进报告---
{bug}
---报告结束---
'''

# 3. 续写提示
BUG2_CONTINUATION_PROMPT = '''\
你是资深 Python 工程师。你正在协助完成一个被截断的文件块的续写。
下面是当前项目中被截断的文件内容，以及项目的整体需求，请你继续生成文件的剩余内容。

续写格式要求：
---FILE: path/to/file.py
<文件剩余内容>
---END_FILE---

请注意：
1. 只输出**缺失的剩余内容**。
2. 续写完成后，必须加上 ---END_FILE--- 标记。如果文件内容过长，仍需截断，请在截断处添加 "---TRUNCATED---" 标记，程序将再次请求你续写。
3. 不要输出任何额外说明或多余文本。

---被截断的文件块列表---
{truncated_files_dump}
---被截断的文件块列表结束---

---项目原始需求/上下文---
{requirements}
---项目原始需求/上下文结束---
'''

# 生成器/prompts.py

GENERATE_PLAN_PROMPT = """你是一个全栈架构师。请根据用户需求，编写一份详细的技术实现方案，包含以下内容：

1. 项目概述（1~2 句）
2. 所需文件清单（每行一个相对路径，不要解释）：
   - app.py
   - templates/base.html
   - static/style.css
   - ...

需求：{requirements}
"""

GENERATE_FILE_PROMPT = """你是一个专业开发工程师。请根据以下项目需求和文件清单，**仅生成指定文件的完整内容**。

项目需求：
{requirements}

完整文件清单：
{file_list}

请生成文件：{target_file}
要求：
- 代码完整、可直接运行
- 不要包含任何解释、注释或 markdown
- 如果是 HTML/JS/CSS，请确保语法正确
- 如果是 Python，请包含必要 import
"""

# =============== DEBUG 诊断提示模板 ===============
DEBUG_PROMPT = '''\
你是资深 Python 工程师和调试专家。下面是用户项目中的相关代码块（路径 -> 内容）和一个问题描述。
请根据这些信息，对问题进行分析和诊断，找出潜在的 Bug 或改进点。
你的输出应该是详细的文本诊断结果，**不包含任何文件块**，诊断的结果中包括以文件为单位的精炼步骤。

---相关代码块开始---
{files_dump}
---相关代码块结束---

---问题描述---
{debug}
---问题描述结束---
'''

PATCH_PROMPT = '''\
你是一个代码修改机器人，职责是根据用户指令对给定的代码内容进行最**最小化**、最**精确**的修改。
你的输出必须是**一个且只有一个** JSON 数组，格式如下：

[
    {
        "find": "<要查找的精确字符串>",
        "replace": "<用于替换的精确字符串>"
    }
]

**请务必严格遵守以下规则：**
1. **只输出 JSON 数组**，不要包含任何额外的说明、代码块标记（如 ```json）或多余文本。
2. `find` 字段的内容必须是**原始代码中精确存在**的字符串，包括所有空格和换行符。
3. `replace` 字段的内容是用于替换 `find` 字符串的精确目标内容。
4. 你的目标是保持**原始文件的所有格式、缩进和空行**不变，除非用户指令要求改变它们。
5. 针对用户指令，生成最少数量的替换操作。

---用户指令---
{instruction}

---文件路径---
{file_path}

---原始文件内容---
{source_code}
'''

# 在 prompts.py 中添加以下内容

BUG2_REPAIR_PROMPT = """
请根据以下项目文件和bug报告生成修复方案。

项目文件:
{files_dump}

Bug报告:
{bug}

请生成修复后的完整文件。如果内容较长需要分段生成，请在每段结束时标注"<!-- 文件结束，勿再生成 -->"表示完成。
如果需要续写，请按照以下格式输出:

---FILE: path/to/file.py
文件内容...
---END_FILE---

请确保输出格式正确，以便程序解析。
"""

BUG2_CONTINUATION_PROMPT = """
你正在续写一个被截断的文件。请根据之前的上下文继续生成代码。

Bug报告:
{bug}

文件路径:
{file_path}

当前已生成的内容:
{current_content}

请继续生成该文件的剩余部分。如果已经完成，请在最后添加"<!-- 文件结束，勿再生成 -->"标记。
不要重复已经生成的代码。
"""

BUG2_CHECK_PROMPT = """
请检查以下代码是否完整且语法正确:

{code}

如果代码完整且正确，请回复"COMPLETE"。
如果代码不完整，请指出缺少的部分。
如果代码有语法错误，请指出错误位置和原因。
"""



# =============== FLASH PHOTO 提示模板 (文档/总结 - 假设保持不变) ===============
FLASH_PHOTO_PROMPT = '''...'''
FLASH_PHOTO_QUERY_PROMPT = '''...'''


# =============== CODE 提示模板 (任务拆解) ===============
CODE_PROMPT = '''\
你是资深 Python 工程师与项目架构师。下面给出当前项目的一些文件（用于定位）和一个高级自然语言需求。
你的任务：将该需求拆成**按序可执行**的若干步骤，并以**严格的 JSON 列表**格式返回（最外层必须是一个数组）。
每个步骤项必须是 JSON 对象，包含至少两个字段：
- title: 短标题（不超过 60 字），描述该步骤要做的高层目标
- instruction: 精确的、可直接交给 bug 修复流程的自然语言提示词（字符串），该提示词应能被 BUG2_REPAIR_PROMPT 流程完美执行。

示例输出：
[
  {"title": "添加用户模型", "instruction": "在 models/user.py 中添加 User 模型，包含 username(str), email(str) 字段。"},
  {"title": "实现注册接口", "instruction": "修改 routes/auth.py，添加 POST /register 接口，使用 User 模型创建新用户。"}
]

请确保：
1. 严格只输出 JSON 列表。
2. 步骤是可按序执行的原子任务。
3. instruction 必须是精确、可执行的修复/创建文件提示。

---项目文件列表开始---
{files_dump}
---项目文件列表结束---

---高级需求---
{requirements}
---高级需求结束---
'''